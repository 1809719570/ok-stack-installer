services:
  db:
    image: "mariadb:10.6.15"
    ports:
      - "13306:3306"
    volumes:
      - /etc/localtime:/etc/localtime
      - ./mariadb/initdb.d:/docker-entrypoint-initdb.d
      - ./mariadb/data:/var/lib/mysql
    environment:
      MYSQL_ROOT_PASSWORD: "okstar"

  apacheds:
    build:
      context: ./apacheds
    ports:
      - "10389:10389"

  keycloak:
    build:
      context: ./keycloak
    environment:
      - KC_DB=mariadb
      - KC_DB_URL=jdbc:mariadb://db/keycloak?autoReconnect=true&useUnicode=true&characterEncoding=utf8
      - KC_DB_USERNAME=root
      - KC_DB_PASSWORD=okstar
      - KC_HOSTNAME=localhost
      - KC_HOSTNAME_URL=https://localhost
      - KC_HOSTNAME_ADMIN_URL=https://localhost
      - KEYCLOAK_ADMIN=admin
      - KEYCLOAK_ADMIN_PASSWORD=okstar
      - KEYCLOAK_SAME_SITE_COOKIES=true
      - KC_PROXY_ADDRESS_FORWARDING=true
      - KC_PROXY=edge
      - KC_HTTP_ENABLED=true
      - KC_HTTP_PORT=8080
      - KC_HTTPS_PORT=8443
      - KC_HOSTNAME_STRICT_BACKCHANNEL=true
    volumes:
      - /etc/localtime:/etc/localtime
    ports:
      - 18043:8080
      - 18443:8443
      - 10990:10990
    depends_on:
      - db
      - apacheds
      
  openfire:
    image: "okstarorg/ok-openfire"
    volumes:
      - ./openfire/logs:/var/log/openfire
    ports:
      - 3478:3478
      - 3479:3479
      - 5222:5222
      - 5223:5223
      - 5229:5229
      - 5262:5262
      - 5263:5263
      - 5275:5275
      - 5276:5276
      - 7070:7070
      - 7443:7443
      - 7777:7777
      - 9090:9090
      - 9091:9091
      - 5005:5005
    depends_on:
      - db
      - apacheds

  ok-stack:
    image: "okstarorg/ok-stack-backend:beta"
    depends_on:
      - db
    ports:
      - 18080:80
    volumes:
      - ./ok-stack/logs:/home/okstar/ok-stack/logs